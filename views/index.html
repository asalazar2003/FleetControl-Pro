<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar Sesión - FleetControl-Pro</title>
  <link rel="stylesheet" href="/style.css"> </head>
<body>
  <header>
    <h1>FleetControl-Pro</h1>
    </header>

  <main>
    <section class="login">
      <h2>Iniciar Sesión</h2>
      <form id="loginForm">
        <div class="form-group">
          <label for="nombreUsuario">Nombre de Usuario</label>
          <input type="text" id="nombreUsuario" name="nombreUsuario" placeholder="Ingresa tu nombre de usuario" required>
        </div>

        <div class="form-group">
          <label for="password">Contraseña</label>
          <input type="password" id="password" name="password" placeholder="Ingresa tu contraseña" required>
        </div>

        <button type="submit">Ingresar</button>
        <p id="loginMensaje" style="margin-top: 15px; text-align: center; color: white;"></p>
      </form>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 FleetControl-Pro Copyright</p>
  </footer>
  <script>
    const loginFormEl = document.getElementById('loginForm');
    const nombreUsuarioInputEl = document.getElementById('nombreUsuario'); // Corregido el nombre de la variable
    const passwordInputEl = document.getElementById('password'); // Corregido el nombre de la variable
    const loginMensajeEl = document.getElementById('loginMensaje');

    // Limpiar cualquier "sesión" simulada al cargar la página de login
    sessionStorage.removeItem('fleetControlUserLoggedIn');
    sessionStorage.removeItem('fleetControlUserData');


    loginFormEl.addEventListener('submit', async function(event) {
      event.preventDefault(); // Prevenir el envío tradicional del formulario
      loginMensajeEl.textContent = 'Procesando...';
      loginMensajeEl.style.color = 'white'; // Color neutral mientras procesa

      const nombreUsuario = nombreUsuarioInputEl.value;
      const password = passwordInputEl.value;

      if (!nombreUsuario || !password) {
        loginMensajeEl.textContent = 'Por favor, ingresa nombre de usuario y contraseña.';
        loginMensajeEl.style.color = 'orange'; // Un color para advertencias leves
        return;
      }

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ nombreUsuario, password }), // Asegúrate que las claves coincidan con req.body en el backend
        });

        const result = await response.json(); // Siempre intenta parsear la respuesta como JSON

        if (response.ok) { // Status 200-299 indica éxito
          loginMensajeEl.textContent = result.message || 'Login exitoso. Redirigiendo...';
          loginMensajeEl.style.color = 'lightgreen'; // Verde para éxito

          // Simulación de sesión para uso local: guardar info del usuario en sessionStorage
          if (result.usuario) {
            sessionStorage.setItem('fleetControlUserLoggedIn', 'true');
            sessionStorage.setItem('fleetControlUserData', JSON.stringify(result.usuario));
          }

          // Redirigir al dashboard después de un breve momento
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 1000);

        } else { // Error (status 4xx o 5xx)
          loginMensajeEl.textContent = `Error: ${result.error || 'Credenciales incorrectas o error del servidor.'}`;
          loginMensajeEl.style.color = 'salmon'; // Rojo/salmón para errores
        }
      } catch (error) {
        // Este catch es para errores de red (ej. el servidor no responde) o si response.json() falla
        console.error('Error de red o al parsear JSON en el login:', error);
        loginMensajeEl.textContent = 'Error de conexión al intentar iniciar sesión. Intenta de nuevo.';
        loginMensajeEl.style.color = 'salmon';
      }
    });
  </script>
</body>
</html>
